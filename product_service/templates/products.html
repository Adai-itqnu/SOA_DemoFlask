<!DOCTYPE html>
<html>
  <head>
    <title>Quản lý sản phẩm</title>
  </head>
  <body>
    <h2>Xin chào {{ username }}</h2>
    <p><a href="http://127.0.0.1:5000/login">Đăng xuất</a></p>

    <h3>Thêm sản phẩm mới</h3>
    <form onsubmit="return addProduct(event)">
      <input id="id" type="number" placeholder="ID" required />
      <input id="name" type="text" placeholder="Tên sản phẩm" required />
      <input id="description" type="text" placeholder="Mô tả" />
      <input id="price" type="number" step="0.01" placeholder="Giá" required />
      <input id="quantity" type="number" placeholder="Số lượng" required />
      <button type="submit">Thêm sản phẩm</button>
    </form>

    <h3>Danh sách sản phẩm</h3>
    <table border="1" cellpadding="5" style="margin-top: 20px">
      <tr>
        <th>ID</th>
        <th>Tên</th>
        <th>Giá</th>
        <th>Số lượng</th>
        <th>Ngày cập nhật</th>
        <th>Cập nhật</th>
        <th>Xóa theo SL</th>
      </tr>
      {% for p in products %}
      <tr>
        <td>{{ p.id }}</td>
        <td><input type="text" id="name_{{ p.id }}" value="{{ p.name }}" /></td>
        <td>
          <input type="number" id="price_{{ p.id }}" value="{{ p.price }}" />
        </td>
        <td>
          <input
            type="number"
            id="quantity_{{ p.id }}"
            value="{{ p.quantity }}"
          />
        </td>
        <td>{{ p.updated_at }}</td>
        <td>
          <button onclick="updateProduct('{{ p.id }}')">Lưu</button>
        </td>
        <td>
          <input
            type="number"
            id="del_amount_{{ p.id }}"
            min="1"
            placeholder="Số lượng"
          />
          <button onclick="deleteProduct('{{ p.id }}')">Xóa</button>
        </td>
      </tr>
      {% endfor %}
    </table>

    <script>
      async function addProduct(event) {
        event.preventDefault();
        const data = {
          id: parseInt(document.getElementById("id").value),
          name: document.getElementById("name").value,
          description: document.getElementById("description").value,
          price: parseFloat(document.getElementById("price").value),
          quantity: parseInt(document.getElementById("quantity").value),
        };
        await fetch("/products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        location.reload();
      }

      async function updateProduct(id) {
        const data = {
          name: document.getElementById(`name_${id}`).value,
          price: parseFloat(document.getElementById(`price_${id}`).value),
          quantity: parseInt(document.getElementById(`quantity_${id}`).value),
        };
        await fetch(`/products/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        location.reload();
      }

      async function deleteProduct(id) {
        const amount = parseInt(
          document.getElementById(`del_amount_${id}`).value
        );
        if (!amount || amount <= 0) {
          alert("Nhập số lượng cần xóa!");
          return;
        }
        await fetch(`/products/${id}`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount }),
        });
        location.reload();
      }
    </script>
  </body>
</html>
